---
description: Guide to creating a new MCP tool
globs: 
alwaysApply: false
---

# Creating a New MCP Tool

## Files to Modify

```
For a new tool "category_action":

1. Python
   └── Python/tools/category_tools.py     → Add tool function

2. C++ 
   ├── Public/Commands/UnrealCompanionXxxCommands.h   → Declare handler
   ├── Private/Commands/UnrealCompanionXxxCommands.cpp → Implement handler
   └── Private/UnrealCompanionBridge.cpp              → ADD ROUTE! (CRITICAL)

3. Documentation
   └── Docs/Tools/category_tools.md       → Document the tool
```

---

## Step 1: Python Tool

**File:** `Python/tools/category_tools.py`

```python
@mcp.tool()
def category_action(
    ctx: Context,
    required_param: str,
    optional_param: float = 100.0,
    graph_name: str = None
) -> Dict[str, Any]:
    """
    Brief description of what the tool does.
    
    Args:
        required_param: Description of required parameter
        optional_param: Description with default value (default: 100.0)
        graph_name: Optional graph name (defaults to EventGraph)
        
    Returns:
        Response containing:
        - result_field: Description
        - other_field: Description
        
    Example:
        category_action("MyAsset", optional_param=50.0)
    """
    from unreal_mcp_server import get_unreal_connection
    
    try:
        params = {"required_param": required_param}
        if optional_param != 100.0:
            params["optional_param"] = optional_param
        if graph_name:
            params["graph_name"] = graph_name
        
        unreal = get_unreal_connection()
        if not unreal:
            return {"success": False, "error": "Failed to connect to Unreal Engine"}
        
        response = unreal.send_command("category_action", params)
        return response or {"success": False, "error": "No response"}
        
    except Exception as e:
        logger.error(f"Error in category_action: {e}")
        return {"success": False, "error": str(e)}
```

### Python Rules

- Function name = C++ command name (snake_case)
- Explicit types (no `Any`, `Union`, `Optional[T]`)
- Use `x: T = None` for optionals
- Complete docstring with Args, Returns, Example
- Import `get_unreal_connection` INSIDE the function (lazy import)

---

## Step 2: C++ Header

**File:** `Public/Commands/UnrealCompanionXxxCommands.h`

```cpp
// Add declaration in appropriate section
TSharedPtr<FJsonObject> HandleCategoryAction(const TSharedPtr<FJsonObject>& Params);
```

---

## Step 3: C++ Implementation

**File:** `Private/Commands/UnrealCompanionXxxCommands.cpp`

```cpp
TSharedPtr<FJsonObject> FUnrealCompanionXxxCommands::HandleCategoryAction(const TSharedPtr<FJsonObject>& Params)
{
    // 1. Parse REQUIRED parameters
    FString RequiredParam;
    if (!Params->TryGetStringField(TEXT("required_param"), RequiredParam))
    {
        return FUnrealCompanionCommonUtils::CreateErrorResponse(TEXT("Missing 'required_param' parameter"));
    }

    // 2. Parse OPTIONAL parameters with defaults
    float OptionalParam = 100.0f;
    Params->TryGetNumberField(TEXT("optional_param"), OptionalParam);

    // 3. VALIDATE inputs
    UBlueprint* Blueprint = FUnrealCompanionCommonUtils::FindBlueprint(BlueprintName);
    if (!Blueprint)
    {
        return FUnrealCompanionCommonUtils::CreateErrorResponse(
            FString::Printf(TEXT("Blueprint not found: %s"), *BlueprintName));
    }

    // 4. EXECUTE logic
    // ... your implementation ...

    // 5. MARK as modified (for Blueprints)
    FBlueprintEditorUtils::MarkBlueprintAsModified(Blueprint);

    // 6. LOG success
    UE_LOG(LogTemp, Display, TEXT("category_action: Success - %s"), *ResultInfo);

    // 7. RETURN result
    TSharedPtr<FJsonObject> ResultObj = MakeShared<FJsonObject>();
    ResultObj->SetStringField(TEXT("status"), TEXT("success"));
    ResultObj->SetStringField(TEXT("result_field"), ResultValue);
    return ResultObj;
}
```

### Add to HandleCommand

```cpp
// In FUnrealCompanionXxxCommands::HandleCommand()
else if (CommandType == TEXT("category_action"))
{
    return HandleCategoryAction(Params);
}
```

---

## Step 4: Bridge Route (CRITICAL!)

**File:** `Private/UnrealCompanionBridge.cpp`

```cpp
// In ProcessCommand() - ADD TO COMMAND LIST
else if (CommandType == TEXT("category_action") ||
         // ... other commands in this category
        )
{
    ResultJson = XxxCommands->HandleCommand(CommandType, Params);
}
```

**⚠️ IF YOU FORGET THIS STEP, THE COMMAND RETURNS "Unknown command"!**

---

## Step 5: Documentation

**File:** `Docs/Tools/category_tools.md`

```markdown
# Category Tools

Brief description of this tool category.

## Tools

| Tool | Description |
|------|-------------|
| `category_action` | Brief description |

## Examples

### category_action

\`\`\`python
category_action(
    required_param="value",
    optional_param=50.0
)
\`\`\`
```

---

## Checklist

```
□ 1. PYTHON
  □ Function added in Python/tools/category_tools.py
  □ snake_case name matching C++
  □ Complete docstring (Args, Returns, Example)
  □ Explicit types (no Any/Union/Optional)
  □ Error handling with try/except

□ 2. C++ HEADER
  □ Declaration in Public/Commands/UnrealCompanionXxxCommands.h

□ 3. C++ IMPLEMENTATION
  □ Handler in Private/Commands/UnrealCompanionXxxCommands.cpp
  □ Parse required params with validation
  □ Parse optional params with defaults
  □ Input validation
  □ MarkBlueprintAsModified if applicable
  □ UE_LOG for debug
  □ Return JSON with status

□ 4. C++ HANDLECOMMAND
  □ Route added in HandleCommand()

□ 5. C++ BRIDGE (⚠️ CRITICAL)
  □ Route added in UnrealCompanionBridge.cpp ProcessCommand()

□ 6. DOCUMENTATION
  □ Docs/Tools/category_tools.md updated

□ 7. TEST
  □ Recompile C++ plugin
  □ Restart Unreal Editor
  □ Restart MCP Python server
  □ Test tool manually
```

---

## Category → File Mapping

| Category | Python | C++ Commands |
|----------|--------|--------------|
| `asset_*` | asset_tools.py | UnrealCompanionAssetCommands |
| `blueprint_*` | blueprint_tools.py | UnrealCompanionBlueprintCommands |
| `graph_*` | graph_tools.py | UnrealCompanionGraphCommands |
| `widget_*` | widget_tools.py | UnrealCompanionUMGCommands |
| `material_*` | material_tools.py | UnrealCompanionMaterialCommands |
| `world_*` | world_tools.py | UnrealCompanionWorldCommands |
| `level_*` | level_tools.py | UnrealCompanionLevelCommands |
| `light_*` | light_tools.py | UnrealCompanionLightCommands |
| `viewport_*` | viewport_tools.py | UnrealCompanionViewportCommands |
| `editor_*` | editor_tools.py | - |
| `python_*` | python_tools.py | - |
| `project_*` | project_tools.py | UnrealCompanionProjectCommands |
