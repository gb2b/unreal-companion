# P5.2 Moteur Workflow Dynamique (LLM Questions)

## Objectif

Implémenter un moteur de workflow où le LLM génère et adapte les questions en fonction du contexte, tout en respectant la structure définie.

## Prérequis

- [x] P2.4 - Workflows YAML
- [x] P2.5 - Expérience ludique

## Fichiers à Créer

- `web-ui/server/services/dynamic_workflow_engine.py`
- `web-ui/server/prompts/dynamic_workflow_prompts.py`

## Spécifications

### Comportement Dynamique

- Workflow YAML = squelette avec étapes et infos à collecter
- LLM reformule les questions selon le contexte
- LLM skip les questions si info déjà connue (Brief, GDD)
- LLM propose des options pertinentes basées sur les réponses

### Exemples

```yaml
# Workflow définit:
question: "Quel est le genre principal ?"

# Si le Brief existe et mentionne "exploration":
LLM: "Je vois que ton Brief parle d'exploration. On reste là-dessus ou tu veux préciser ?"
options: ["Exploration (garder)", "Exploration-Puzzle", "Autre..."]

# Si aucune info:
LLM: "Quel genre de jeu veux-tu créer ?"
options: ["Action", "RPG", "Puzzle", "Adventure", "Autre..."]
```

### Moteur

```python
class DynamicWorkflowEngine:
    async def generate_question(
        self,
        step: WorkflowStep,
        question: WorkflowQuestion,
        context: WorkflowContext
    ) -> DynamicQuestion:
        """Génère une question adaptée au contexte."""

        # Vérifier si l'info existe déjà
        existing = self.find_existing_info(question.id, context)

        if existing:
            return self.generate_confirmation_question(question, existing)

        # Générer les suggestions basées sur le contexte
        suggestions = await self.generate_contextual_suggestions(question, context)

        # Reformuler la question
        reformulated = await self.reformulate_question(question, context)

        return DynamicQuestion(
            original=question,
            prompt=reformulated,
            suggestions=suggestions,
            skip_if_confirmed=existing is not None
        )
```

## Critères d'Acceptation

- [ ] Questions reformulées selon contexte
- [ ] Skip automatique si info existe
- [ ] Confirmation proposée pour infos existantes
- [ ] Suggestions contextuelles générées
- [ ] Fallback sur questions scriptées si LLM échoue
- [ ] Tests passent
