# P3.2 Contexte STUDIO ‚Üí EDITOR (et inverse)

## Objectif

Impl√©menter le pont de contexte bidirectionnel entre Studio et Editor : injection des artifacts dans l'Editor, et proposition de discussions Studio depuis l'Editor.

## Pr√©requis

- [x] P1.2 - Structure artifacts/
- [x] P2.1 - Production Board avec tasks
- [x] P3.1 - Unreal Agent

## Fichiers √† Cr√©er

- `web-ui/server/services/context_bridge.py` - Service de pont
- `web-ui/src/hooks/useContextBridge.ts` - Hook React
- `web-ui/src/components/editor/ContextPanel.tsx` - Affichage contexte
- `web-ui/src/components/editor/StudioSuggestion.tsx` - Suggestion retour Studio

## Sp√©cifications

### Flow STUDIO ‚Üí EDITOR

```
STUDIO                           EDITOR
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê             ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 ‚îÇ             ‚îÇ                 ‚îÇ
‚îÇ  Task "ready"   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ  Contexte       ‚îÇ
‚îÇ  dans le Board  ‚îÇ   inject    ‚îÇ  enrichi        ‚îÇ
‚îÇ                 ‚îÇ             ‚îÇ                 ‚îÇ
‚îÇ  - GDD section  ‚îÇ             ‚îÇ  "Tu travailles ‚îÇ
‚îÇ  - Brief        ‚îÇ             ‚îÇ   sur X, le GDD ‚îÇ
‚îÇ  - Artifacts    ‚îÇ             ‚îÇ   dit Y..."     ‚îÇ
‚îÇ                 ‚îÇ             ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Injection de Contexte

```python
class ContextBridge:
    def __init__(self, project_path: str):
        self.project_path = project_path
        self.companion_path = Path(project_path) / ".unreal-companion"

    def get_context_for_task(self, task: Task) -> TaskContext:
        """Rassemble tout le contexte pertinent pour une task."""

        context = TaskContext(
            task=task,
            project_context=self.load_project_context(),
            relevant_artifacts=self.find_relevant_artifacts(task),
            related_tasks=self.find_related_tasks(task),
            gdd_section=self.extract_gdd_section(task)
        )

        return context

    def load_project_context(self) -> str:
        """Charge le context.md du projet."""
        context_path = self.companion_path / "context.md"
        if context_path.exists():
            return context_path.read_text()
        return ""

    def find_relevant_artifacts(self, task: Task) -> List[Artifact]:
        """Trouve les artifacts pertinents selon les tags/keywords de la task."""
        artifacts = []

        # Recherche par mots-cl√©s dans le titre et description
        keywords = self.extract_keywords(task.title, task.description)

        index_path = self.companion_path / "artifacts" / "index.yaml"
        if index_path.exists():
            index = yaml.safe_load(index_path.read_text())
            for artifact in index.get('artifacts', []):
                if self.matches_keywords(artifact, keywords):
                    artifacts.append(artifact)

        return artifacts

    def extract_gdd_section(self, task: Task) -> Optional[str]:
        """Extrait la section du GDD pertinente pour la task."""
        gdd_path = self.companion_path / "artifacts" / "design" / "gdd.md"
        if not gdd_path.exists():
            return None

        gdd_content = gdd_path.read_text()
        # Extraction intelligente bas√©e sur les keywords de la task
        return self.extract_section(gdd_content, task.title)
```

### Format Contexte Inject√©

```python
CONTEXT_INJECTION_TEMPLATE = """
## Current Task
**{task_title}**
{task_description}

Sector: {task_sector}
Priority: {task_priority}

## Project Context
{project_context_summary}

## Relevant from GDD
{gdd_section}

## Related Artifacts
{artifacts_list}

## Related Tasks
- Depends on: {dependencies}
- Blocking: {blocking_tasks}
"""
```

### Flow EDITOR ‚Üí STUDIO

```
EDITOR                           STUDIO
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê             ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 ‚îÇ             ‚îÇ                 ‚îÇ
‚îÇ  Discussion     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ  Party Mode     ‚îÇ
‚îÇ  technique      ‚îÇ   suggest   ‚îÇ  avec l'√©quipe  ‚îÇ
‚îÇ                 ‚îÇ             ‚îÇ                 ‚îÇ
‚îÇ  "On devrait    ‚îÇ             ‚îÇ  "Discutons de  ‚îÇ
‚îÇ   d√©finir le    ‚îÇ             ‚îÇ   l'architecture‚îÇ
‚îÇ   syst√®me..."   ‚îÇ             ‚îÇ   avec Alex"    ‚îÇ
‚îÇ                 ‚îÇ             ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### D√©tection de Besoin Studio

```python
def detect_studio_opportunity(conversation: Conversation) -> Optional[StudioSuggestion]:
    """D√©tecte quand une discussion Editor devrait aller vers Studio."""

    indicators = [
        # Questions de design
        ("how should", "design", ["game-designer"]),
        ("what if we", "mechanic", ["game-designer"]),

        # Questions d'architecture
        ("architecture", "system design", ["game-architect"]),
        ("should we use", "pattern", ["game-architect"]),

        # Questions artistiques
        ("art style", "visual direction", ["3d-artist"]),
        ("material approach", "look and feel", ["3d-artist"]),

        # Questions de level design
        ("level layout", "pacing", ["level-designer"]),
        ("player flow", "exploration", ["level-designer"]),
    ]

    last_messages = conversation.get_last_n_messages(5)
    combined_text = " ".join([m.content for m in last_messages]).lower()

    for keywords, topic, agents in indicators:
        if any(kw in combined_text for kw in keywords.split()):
            return StudioSuggestion(
                topic=topic,
                suggested_agents=agents,
                reason=f"This seems like a {topic} discussion that would benefit from the team's input."
            )

    return None
```

### UI Suggestion Studio

```tsx
// Dans le chat Editor, quand d√©tect√©
<StudioSuggestion
  suggestion={{
    topic: "system architecture",
    suggestedAgents: ["game-architect", "game-designer"],
    reason: "This design decision would benefit from team input."
  }}
  onAccept={() => switchToStudioPartyMode(suggestion)}
  onDismiss={() => dismissSuggestion()}
/>

// Affichage
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üí° Unreal Agent suggests:                                      ‚îÇ
‚îÇ                                                                ‚îÇ
‚îÇ  "This looks like a system architecture discussion.             ‚îÇ
‚îÇ   Want to discuss it with Alex (Architect) and Maya (Designer) ‚îÇ
‚îÇ   in Party Mode?"                                              ‚îÇ
‚îÇ                                                                ‚îÇ
‚îÇ  [üë• Start Party Mode]  [Continue here]                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Context Panel (Sidebar Editor)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üìã Context                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                 ‚îÇ
‚îÇ  Current Task:                  ‚îÇ
‚îÇ  ‚ñ∂ "Create Save System"        ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  üìÑ From GDD:                   ‚îÇ
‚îÇ  "Save system should support   ‚îÇ
‚îÇ   multiple profiles and auto-   ‚îÇ
‚îÇ   save every 5 minutes..."      ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  [View full section]            ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  üîó Related:                    ‚îÇ
‚îÇ  ‚Ä¢ Brief: Core Systems          ‚îÇ
‚îÇ  ‚Ä¢ Task: Player Controller      ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  üë• Discuss with team?          ‚îÇ
‚îÇ  [Start Party Mode]             ‚îÇ
‚îÇ                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Crit√®res d'Acceptation

- [ ] Contexte inject√© automatiquement au lancement d'une task
- [ ] GDD section pertinente extraite et affich√©e
- [ ] Artifacts li√©s trouv√©s et list√©s
- [ ] Context Panel visible dans l'Editor
- [ ] D√©tection de besoin Studio fonctionnelle
- [ ] Suggestion Party Mode quand pertinent
- [ ] Transition fluide Editor ‚Üí Studio
- [ ] Transition fluide Studio ‚Üí Editor (via task)
- [ ] Tests passent

## Tests √† √âcrire

### Unit Tests

```python
def test_context_for_task():
    # V√©rifie l'assemblage du contexte

def test_gdd_section_extraction():
    # V√©rifie l'extraction de section GDD

def test_relevant_artifacts_finding():
    # V√©rifie la recherche d'artifacts pertinents

def test_studio_opportunity_detection():
    # V√©rifie la d√©tection de besoin Studio
```

### Unit Tests (React)

```typescript
describe('ContextPanel', () => {
  it('should display current task info');
  it('should show GDD section');
  it('should list related artifacts');
});

describe('StudioSuggestion', () => {
  it('should appear when detected');
  it('should trigger Party Mode on accept');
});
```

### E2E Tests

```typescript
describe('Context Bridge E2E', () => {
  it('should inject context when launching task');
  it('should suggest Studio and switch modes');
});
```

## Notes

- L'extraction de section GDD peut utiliser le LLM pour plus de pr√©cision
- Les suggestions Studio ne doivent pas √™tre intrusives
- Le contexte doit √™tre rafra√Æchi si les artifacts changent
- Pr√©voir un cache pour √©viter de recharger √† chaque message
