# P3.1 Unreal Agent + Skills

## Objectif

Cr√©er l'Unreal Agent, agent par d√©faut du mode Editor, avec le syst√®me de skills pour les op√©rations MCP courantes.

## Pr√©requis

- [x] P1.1 - Structure agents/defaults/
- [x] Syst√®me MCP existant fonctionnel

## Fichiers √† Cr√©er

```
~/.unreal-companion/
‚îú‚îÄ‚îÄ agents/defaults/
‚îÇ   ‚îî‚îÄ‚îÄ unreal-agent.yaml        # Agent principal Editor
‚îî‚îÄ‚îÄ skills/
    ‚îú‚îÄ‚îÄ index.yaml               # Liste des skills
    ‚îú‚îÄ‚îÄ blueprint-creation.yaml  # Skill cr√©ation BP
    ‚îú‚îÄ‚îÄ material-setup.yaml      # Skill mat√©riaux
    ‚îú‚îÄ‚îÄ level-building.yaml      # Skill levels
    ‚îú‚îÄ‚îÄ graph-nodes.yaml         # Skill nodes Blueprint
    ‚îî‚îÄ‚îÄ widget-creation.yaml     # Skill UI
```

- `web-ui/server/services/skills_service.py` - Chargement skills
- `web-ui/server/prompts/unreal_agent_prompts.py` - Prompts

## Sp√©cifications

### unreal-agent.yaml

```yaml
id: unreal-agent
name: "Unreal Agent"
description: "Your assistant for controlling Unreal Engine"

# Modes support√©s
modes:
  studio: false
  editor: true  # Agent par d√©faut de l'Editor

# Personnalit√©
persona:
  avatar: "ü§ñ"
  tone: professional  # Moins casual que les agents Studio
  uses_emojis: false
  verbosity: medium

  expressions:
    thinking: "‚öôÔ∏è"
    success: "‚úÖ"
    error: "‚ùå"
    working: "üîÑ"

  catchphrases:
    greeting: "Ready to build. What do you need?"
    success: ["Done.", "Created successfully.", "All set."]
    error: ["Hmm, that didn't work. Let me try differently."]

# Sp√©cialit√©s
expertise:
  - blueprint_systems
  - material_creation
  - level_design
  - ui_widgets
  - unreal_engine_general

# Skills disponibles
skills:
  - blueprint-creation
  - material-setup
  - level-building
  - graph-nodes
  - widget-creation

# Comportement sp√©cial
behaviors:
  # Peut sugg√©rer de d√©l√©guer √† un sp√©cialiste
  suggest_specialist: true
  specialist_threshold: 0.7  # Confiance minimale avant suggestion

  # Ex√©cute directement si possible
  prefer_execution: true

# System prompt
system_prompt: |
  You are the Unreal Agent, an AI assistant specialized in controlling
  Unreal Engine through MCP tools.

  Your role:
  - Execute user requests using available MCP tools
  - Create Blueprints, Materials, Widgets, and Level structures
  - Suggest best practices for Unreal Engine development
  - When a task is better suited for a specialist (3D Artist, Level Designer),
    suggest switching to that agent

  Communication style:
  - Be concise and professional
  - Show what you're doing (tool calls) and results
  - If something fails, explain why and try alternatives

  Context injection:
  - Use project context (GDD, architecture) to inform decisions
  - Reference existing assets and naming conventions
  - Follow project structure (Content/_Core, Content/Data, etc.)
```

### Format Skill YAML

```yaml
# skills/blueprint-creation.yaml
id: blueprint-creation
name: "Blueprint Creation"
description: "Create and configure Blueprint assets"

# Quand utiliser ce skill
triggers:
  - "create blueprint"
  - "new blueprint"
  - "make a BP"
  - "blueprint for"

# Tools MCP utilis√©s
tools:
  - blueprint_create
  - blueprint_variable_batch
  - blueprint_component_batch
  - graph_batch
  - core_save

# Workflow typique
workflow:
  steps:
    - name: "Create Blueprint"
      tool: blueprint_create
      params:
        name: "{{requested_name}}"
        parent_class: "{{parent_class | default: 'Actor'}}"

    - name: "Add Variables"
      tool: blueprint_variable_batch
      condition: "{{variables | length > 0}}"
      params:
        blueprint_name: "{{requested_name}}"
        variables: "{{variables}}"

    - name: "Add Components"
      tool: blueprint_component_batch
      condition: "{{components | length > 0}}"
      params:
        blueprint_name: "{{requested_name}}"
        components: "{{components}}"

    - name: "Save"
      tool: core_save
      params:
        scope: "modified"

# Exemples pour le LLM
examples:
  - input: "Create a BP_Enemy with health and damage variables"
    expected_tools:
      - blueprint_create: { name: "BP_Enemy", parent_class: "Character" }
      - blueprint_variable_batch:
          variables:
            - { name: "Health", type: "float", default: 100 }
            - { name: "Damage", type: "float", default: 10 }

  - input: "Make a BP_Pickup with a static mesh and collision"
    expected_tools:
      - blueprint_create: { name: "BP_Pickup" }
      - blueprint_component_batch:
          components:
            - { ref: "mesh", class: "StaticMeshComponent" }
            - { ref: "collision", class: "SphereComponent" }
```

### Service Skills

```python
class SkillsService:
    def __init__(self):
        self.skills = self.load_skills()

    def load_skills(self) -> Dict[str, Skill]:
        """Charge tous les skills depuis YAML."""
        skills_dir = Path.home() / ".unreal-companion" / "skills"
        skills = {}
        for path in skills_dir.glob("*.yaml"):
            if path.name != "index.yaml":
                skill = yaml.safe_load(path.read_text())
                skills[skill['id']] = Skill(**skill)
        return skills

    def match_skill(self, user_input: str) -> Optional[Skill]:
        """Trouve le skill le plus pertinent pour l'input."""
        for skill in self.skills.values():
            for trigger in skill.triggers:
                if trigger.lower() in user_input.lower():
                    return skill
        return None

    def get_skill_context(self, skill: Skill) -> str:
        """G√©n√®re le contexte pour le LLM avec exemples du skill."""
        return f"""
        Skill: {skill.name}
        Description: {skill.description}

        Available tools: {', '.join(skill.tools)}

        Examples:
        {self.format_examples(skill.examples)}
        """
```

### Prompt avec Skills

```python
UNREAL_AGENT_PROMPT = """
{system_prompt}

PROJECT CONTEXT:
{project_context}

AVAILABLE SKILLS:
{skills_summary}

{skill_specific_context}

USER REQUEST:
{user_input}

Respond with:
1. Brief acknowledgment of what you'll do
2. Tool calls needed (in order)
3. Summary of results

If the request is better handled by a specialist agent, suggest:
"This would be better handled by the {specialist}. Switch? [Yes/No]"
"""
```

### Suggestion de Sp√©cialiste

```python
def should_suggest_specialist(request: str, context: ProjectContext) -> Optional[str]:
    """D√©termine si un sp√©cialiste serait plus appropri√©."""

    specialist_indicators = {
        'level-designer': ['level design', 'lighting', 'layout', 'world building', 'terrain'],
        '3d-artist': ['material', 'texture', 'shader', 'visual', 'art style'],
        'game-architect': ['system design', 'architecture', 'subsystem', 'data flow']
    }

    for specialist, keywords in specialist_indicators.items():
        if any(kw in request.lower() for kw in keywords):
            return specialist

    return None
```

## Crit√®res d'Acceptation

- [ ] unreal-agent.yaml cr√©√© et fonctionnel
- [ ] Au moins 5 skills d√©finis (blueprint, material, level, graph, widget)
- [ ] Skills charg√©s et utilis√©s dans les prompts
- [ ] Exemples de skills utilis√©s pour guider le LLM
- [ ] Suggestion de sp√©cialiste quand pertinent
- [ ] Int√©gration avec le syst√®me MCP existant
- [ ] Tests passent

## Tests √† √âcrire

### Unit Tests

```python
def test_load_unreal_agent():
    # V√©rifie le chargement de l'agent

def test_load_skills():
    # V√©rifie le chargement des skills

def test_match_skill():
    # V√©rifie la d√©tection de skill depuis l'input

def test_specialist_suggestion():
    # V√©rifie les suggestions de sp√©cialiste
```

### Integration Tests

```python
def test_unreal_agent_with_skill():
    # V√©rifie l'ex√©cution d'un skill complet
```

## Notes

- Les skills sont des "recettes" pour guider le LLM, pas des scripts rigides
- Le LLM peut adapter les skills selon le contexte
- Les sp√©cialistes sont sugg√©r√©s, pas impos√©s
- Pr√©voir l'ajout de skills custom par l'utilisateur
