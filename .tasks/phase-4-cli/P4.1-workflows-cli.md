# P4.1 Workflows CLI-Ready

## Objectif

Rendre les workflows ex√©cutables en CLI (Claude Code, Cursor) avec parsing YAML, questions s√©quentielles, et g√©n√©ration d'artifacts.

## Pr√©requis

- [x] P1.4 - CLI Setup (infrastructure Node.js en place)
- [x] P2.4 - Workflows YAML d√©finis
- [x] P2.6 - Gestion sessions

## Fichiers √† Cr√©er/Modifier

> **Note**: Le CLI Node.js existe d√©j√† (P1.4). Cette task ajoute les commandes workflow.

- `cli/src/commands/workflow.js` - Commandes workflow (list, start, resume, status)
- `cli/src/services/workflow-runner.js` - Ex√©cuteur de workflows
- `cli/src/services/session-manager.js` - Gestion sessions CLI
- Documentation dans `Docs/CLI/`

## Sp√©cifications

### Utilisation CLI

```bash
# Lister les workflows disponibles
npx unreal-companion workflow list

# D√©marrer un workflow
npx unreal-companion workflow start game-brief

# Reprendre une session
npx unreal-companion workflow resume

# Voir le status
npx unreal-companion workflow status
```

### Exemple de Session CLI

```text
$ npx unreal-companion workflow start quick-start

üöÄ Quick Start - D√©marrage Rapide
Estim√©: ~2 min

ü§ñ Game Designer:
"Allons √† l'essentiel ! C'est quoi ton jeu ?"

? Nom du projet: The Last Shard

ü§ñ "The Last Shard, j'aime bien ! Et en une phrase ?"

? Pitch en une phrase:
  > Explorer un monde fig√© dans le temps pour d√©couvrir pourquoi

ü§ñ "Myst√©rieux ! Et le genre ?"

? Genre:
  ‚ùØ Action
    RPG
    Puzzle
    Autre...

[Genre s√©lectionn√©: RPG]

ü§ñ "Parfait ! Voici ton brief rapide..."

‚ú® Session termin√©e!
üìÑ Artifact cr√©√©: artifacts/briefs/quick-brief.md

Prochaines √©tapes sugg√©r√©es:
  1. npx unreal-companion workflow start game-brief  # Approfondir
  2. npx unreal-companion workflow start brainstorm  # Explorer les m√©caniques
```

### Workflow Runner

```javascript
// cli/src/services/workflow-runner.js
import inquirer from 'inquirer';
import chalk from 'chalk';
import ora from 'ora';
import { SessionManager } from './session-manager.js';

export class WorkflowRunner {
  constructor(projectPath) {
    this.projectPath = projectPath;
    this.sessionManager = new SessionManager(projectPath);
  }

  async runWorkflow(workflowId) {
    // Charger le workflow
    const workflow = this.loadWorkflow(workflowId);

    // V√©rifier s'il y a une session existante
    const existing = this.sessionManager.findActive(workflowId);
    if (existing) {
      const { resume } = await inquirer.prompt([{
        type: 'confirm',
        name: 'resume',
        message: 'Une session existe. Reprendre ?',
        default: true
      }]);
      if (resume) return this.resumeSession(existing);
    }

    // Nouvelle session
    const session = this.sessionManager.create(workflowId);

    // Header
    this.printHeader(workflow);

    // Parcourir les steps
    for (const step of workflow.steps) {
      if (!this.shouldShowStep(step, session.responses)) continue;
      await this.runStep(step, session);
    }

    // G√©n√©rer l'artifact
    const artifact = this.generateArtifact(workflow, session);

    // C√©l√©bration finale
    this.printCompletion(workflow, artifact);

    return session;
  }

  async runStep(step, session) {
    // Message de l'agent
    const agentMessage = await this.generateAgentMessage(step, session);
    this.printAgentMessage(agentMessage);

    // Questions de l'√©tape
    for (const question of step.questions) {
      if (!this.shouldShowQuestion(question, session.responses)) continue;

      const answer = await this.promptQuestion(question, session);

      // R√©action de l'agent
      const reaction = await this.generateReaction(answer, session);
      this.printReaction(reaction);

      // Sauvegarder
      session.addResponse(step.id, question.id, answer, reaction);
      this.sessionManager.save(session);
    }

    // Milestone?
    if (step.milestone) {
      this.printMilestone(step.milestone, session);
    }
  }
}
```

### Types de Questions CLI

```javascript
async promptQuestion(question, session) {
  if (question.type === 'text') {
    const { answer } = await inquirer.prompt([{
      type: 'input',
      name: 'answer',
      message: question.prompt,
      default: question.placeholder
    }]);
    return answer;
  }

  if (question.type === 'textarea') {
    const { answer } = await inquirer.prompt([{
      type: 'editor',
      name: 'answer',
      message: question.prompt
    }]);
    return answer;
  }

  if (question.type === 'single') {
    const choices = question.options.map(opt => opt.label);
    if (question.allowCustom) choices.push('Autre...');

    const { answer } = await inquirer.prompt([{
      type: 'list',
      name: 'answer',
      message: question.prompt,
      choices
    }]);

    if (answer === 'Autre...') {
      const { custom } = await inquirer.prompt([{
        type: 'input',
        name: 'custom',
        message: 'Pr√©cise:'
      }]);
      return custom;
    }
    return answer;
  }

  if (question.type === 'multiple') {
    const { answer } = await inquirer.prompt([{
      type: 'checkbox',
      name: 'answer',
      message: question.prompt,
      choices: question.options.map(opt => opt.label),
      validate: (input) => input.length >= (question.minSelections || 1)
    }]);
    return answer;
  }
}
```

### G√©n√©ration Artifact

```javascript
import { mkdirSync, writeFileSync } from 'fs';
import { dirname, join } from 'path';

generateArtifact(workflow, session) {
  const template = workflow.output.template;
  const variables = this.collectVariables(session);

  // Remplacer les variables
  const content = this.renderTemplate(template, variables);

  // Chemin de sortie
  const outputPath = join(this.companionPath, workflow.output.path);
  mkdirSync(dirname(outputPath), { recursive: true });

  // √âcrire
  writeFileSync(outputPath, content);

  // Mettre √† jour l'index
  this.updateArtifactsIndex(outputPath, workflow, session);

  return outputPath;
}
```

### Int√©gration avec Claude Code / Cursor

```markdown
# Dans CLAUDE.md du projet

## Workflows Disponibles

Pour conceptualiser ton jeu, utilise les workflows:

\`\`\`bash
# D√©marrer un brief rapide
npx unreal-companion workflow start quick-start

# Brief complet
npx unreal-companion workflow start game-brief

# Brainstorming
npx unreal-companion workflow start brainstorm
\`\`\`

Les artifacts g√©n√©r√©s seront dans `.unreal-companion/artifacts/`.
```

## Crit√®res d'Acceptation

- [ ] Commande `companion workflow list` fonctionnelle
- [ ] Commande `companion workflow start <id>` fonctionnelle
- [ ] Questions interactives (text, select, checkbox)
- [ ] R√©actions de l'agent g√©n√©r√©es
- [ ] Sauvegarde session apr√®s chaque r√©ponse
- [ ] Reprise de session possible
- [ ] Artifact g√©n√©r√© √† la fin
- [ ] C√©l√©brations et milestones affich√©s
- [ ] Compatible avec Claude Code / Cursor
- [ ] Tests passent

## Tests √† √âcrire

### Unit Tests

```javascript
// cli/tests/workflow.test.js
describe('WorkflowRunner', () => {
  test('loadWorkflow loads YAML correctly')
  test('promptQuestion handles all question types')
  test('generateArtifact creates file from template')
});

describe('SessionManager', () => {
  test('create initializes new session')
  test('save persists session to disk')
  test('findActive returns existing session')
  test('resume restores session state')
});
```

### Integration Tests

```javascript
test('full workflow execution creates artifact', async () => {
  // Mock inquirer prompts
  // Run workflow
  // Verify artifact file created
});
```

## Notes

- Utiliser `inquirer` (d√©j√† install√© via P1.4) pour les prompts interactifs
- Les r√©actions peuvent √™tre g√©n√©r√©es via LLM ou pr√©-d√©finies
- Pr√©voir un mode `--non-interactive` pour les scripts
- Le CLI fonctionne standalone (pas besoin du serveur web)
- S'int√®gre avec l'infrastructure CLI existante (P1.4)
