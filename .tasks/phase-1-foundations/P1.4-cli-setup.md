# P1.4 CLI Setup & Open Source Infrastructure

## Objectif

Créer une interface CLI npm-style (`npx unreal-companion`) pour l'installation, la configuration et le lancement du projet, avec les bonnes pratiques open-source.

## Prérequis

- [x] P1.1 - Structure globale (pour les chemins ~/.unreal-companion/)

## Status

**FAIT** - Complété le 2024-01-22

## Fichiers Créés

```
cli/
├── bin/
│   └── unreal-companion.js      # Point d'entrée CLI
├── src/
│   ├── commands/
│   │   ├── install.js           # Installation interactive
│   │   ├── upgrade.js           # Mise à jour avec migrations
│   │   ├── start.js             # Lancement serveur Web UI
│   │   ├── init.js              # Initialisation projet Unreal
│   │   ├── status.js            # Affichage état installation
│   │   └── doctor.js            # Diagnostic problèmes
│   ├── utils/
│   │   └── helpers.js           # Utilitaires (chemins, tips, config)
│   └── index.js                 # Export programmatique
├── package.json                 # Dépendances CLI
└── README.md                    # Documentation CLI

# À la racine du repo
package.json                     # Avec bin: { "unreal-companion": "./cli/bin/..." }

# Open Source
CODE_OF_CONDUCT.md               # Contributor Covenant v2.0
CHANGELOG.md                     # Keep a Changelog format

# GitHub
.github/
├── FUNDING.yml                  # GitHub Sponsors
├── REPO_SETUP.md                # Guide config GitHub (branch protection, etc.)
└── workflows/
    └── ci.yml                   # Jobs: lint-python, test-python, test-cli, lint-web-ui, build-web-ui
```

## Commandes Implémentées

| Commande | Description |
|----------|-------------|
| `npx unreal-companion install` | Setup interactif (langue, thème, agents, workflows) |
| `npx unreal-companion upgrade` | Mise à jour avec migrations (agents, workflows, components) |
| `npx unreal-companion start` | Lance le serveur Web UI |
| `npx unreal-companion init [path]` | Initialise un projet Unreal |
| `npx unreal-companion status` | Affiche l'état de l'installation |
| `npx unreal-companion doctor` | Diagnostique les problèmes |

## Fonctionnalités Clés

### Install Command

- Choix langue (en/fr) et thème (dark/light/system)
- Création structure ~/.unreal-companion/
- Copie agents et workflows par défaut
- Détection automatique des projets Unreal
- Menu post-install interactif :
  - Lancer Web UI
  - Initialiser un projet
  - Configurer MCP (Claude/Cursor/Windsurf)
  - Copier le Plugin Unreal
  - Voir toutes les commandes

### Upgrade Command

- Comparaison de versions avec semver
- Système de migrations pour changements de format
- Upgrade sélectif par composant (agents, workflows, web-ui, plugin)
- Option `--include-projects` pour mettre à jour les fichiers projet
- Option `--dry-run` pour prévisualiser

### Doctor Command

- Vérifications :
  - Installation (dossiers, fichiers, agents, workflows)
  - Dépendances (Node.js 18+, Python 3.10+, pip packages, uv)
  - Composants repo (web-ui, server, mcp, plugin)
  - Variables d'environnement (API keys)
  - Réseau (ports 3179, 55557)
- Affichage avec statuts (✓ OK, ✗ FAIL, ! WARN)

### Tips System

```javascript
// Dans helpers.js
const AGENT_TIPS = [
  { agent: 'Zelda', tip: "A good GDD is a living document..." },
  { agent: 'Solid', tip: "Blueprint first, C++ only when necessary..." },
  // 14 tips de 7 agents différents
];
```

Affiché au lancement sans arguments.

## CI/CD Ajouté

```yaml
# .github/workflows/ci.yml

test-cli:
  - node --check cli/bin/unreal-companion.js
  - node cli/bin/unreal-companion.js --help
  - node cli/bin/unreal-companion.js status --json

lint-web-ui:
  - npm run typecheck
  - npm run lint

build-web-ui:
  - npm run build
```

## Configuration GitHub Documentée

Le fichier `.github/REPO_SETUP.md` contient les instructions pour :

- **Branch Protection** : Require PR, 1 approval, status checks
- **Status Checks Required** : Lint Python, Test Python, Test CLI, Build Web UI
- **Repository Settings** : Squash merge default, auto-delete branches
- **Code Security** : Dependabot, secret scanning, push protection
- **Labels** : bug, enhancement, cli, web-ui, mcp, plugin, agents, workflows

## Impact sur Autres Tasks

### Phase 4 (CLI) - P4.1 Workflows CLI

La task P4.1 prévoyait un CLI Python (`companion workflow start`). Avec notre implémentation Node.js :

**Option 1** : Ajouter les commandes workflow au CLI Node.js existant
```bash
npx unreal-companion workflow start game-brief
npx unreal-companion workflow list
npx unreal-companion workflow resume
```

**Option 2** : Garder séparé - CLI Node.js pour setup, CLI Python pour workflows

**Recommandation** : Option 1 - Unifier dans le CLI Node.js pour une meilleure UX.

### P4.2 Documentation MCP

Les instructions MCP sont déjà partiellement documentées dans `install.js` (printMCPInstructions). À fusionner/référencer.

### P1.1 Structure Globale

Notre `install.js` crée déjà la structure ~/.unreal-companion/. Peut être considéré comme partiellement complété via cette task.

## Critères d'Acceptation

- [x] Commande `npx unreal-companion install` fonctionne
- [x] Commande `npx unreal-companion upgrade` fonctionne
- [x] Commande `npx unreal-companion start` fonctionne
- [x] Commande `npx unreal-companion init` fonctionne
- [x] Commande `npx unreal-companion status` fonctionne
- [x] Commande `npx unreal-companion doctor` fonctionne
- [x] Tips aléatoires affichés au lancement
- [x] Menu post-install interactif
- [x] CI/CD pour CLI
- [x] Fichiers open-source (CODE_OF_CONDUCT, CHANGELOG)
- [x] Documentation GitHub setup

## Tests à Écrire

### Unit Tests (TODO)

```javascript
// cli/tests/helpers.test.js
describe('helpers', () => {
  test('getVersion returns package.json version')
  test('isInstalled checks for marker file')
  test('getRandomTip returns valid tip')
})

// cli/tests/commands.test.js
describe('commands', () => {
  test('install creates global structure')
  test('status returns JSON when --json flag')
  test('doctor checks all dependencies')
})
```

### Integration Tests (TODO)

```javascript
test('full install flow creates all expected files')
test('upgrade preserves user customizations')
```

## Dépendances NPM

```json
{
  "commander": "^12.0.0",      // CLI framework
  "inquirer": "^9.2.0",        // Prompts interactifs
  "chalk": "^5.3.0",           // Couleurs terminal
  "ora": "^8.0.0",             // Spinners
  "semver": "^7.6.0",          // Comparaison versions
  "yaml": "^2.3.0"             // Parse YAML config
}
```

## Notes

- Le CLI est en ES Modules (`"type": "module"` dans package.json)
- Le package.json principal est à la racine du repo (pas dans cli/)
- L'alias court `uc` est disponible en plus de `unreal-companion`
