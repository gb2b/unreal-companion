# P1.3 Système de Tasks (Queues, Dépendances)

## Objectif

Implémenter le système de tasks avec le modèle "Fast-Food Workflow" : tasks parent avec sous-tasks qui progressent entre secteurs.

## Prérequis

- [x] P1.2 - Mise à jour project_init.py (structure tasks/ créée)

## Fichiers à Créer

- `web-ui/server/services/tasks_service.py` - Service backend
- `web-ui/server/routes/tasks.py` - API routes
- `web-ui/src/stores/tasksStore.ts` - Store Zustand
- `web-ui/src/types/tasks.ts` - Types TypeScript

## Spécifications

### Format Task YAML

```yaml
# tasks/active/dev/player-controller.yaml
id: task-player-controller
title: "Player Controller"
description: "Create BP_PlayerController with movement"

# Secteur actuel (peut changer)
sector: dev

# Agent assigné
agent: game-architect

# Priorité
priority: high  # low | medium | high | critical

# État
status: ready  # locked | ready | in_progress | done

# Task parent (optionnel)
parent_id: task-create-enemy  # null si task racine

# Dépendances
requires:
  - task-core-loop

# Historique (append-only, jamais supprimé)
history:
  - date: 2024-01-20T10:00:00Z
    action: created
    by: user

  - date: 2024-01-21T14:30:00Z
    action: started
    by: editor
    session: "conv-abc123"

  - date: 2024-01-21T16:00:00Z
    action: done
    by: editor
    notes: "BP_PlayerController created with basic movement"

  - date: 2024-01-22T09:00:00Z
    action: reopened
    by: user
    reason: "Need to add crouch"

# Compteur d'itérations (incrémenté à chaque reopen)
iteration: 2

# Métadonnées
created_at: 2024-01-20T10:00:00Z
updated_at: 2024-01-22T09:00:00Z
created_by: user  # user | workflow | editor
```

### Modèle "Fast-Food Workflow"

```yaml
# Task parent avec sous-tasks
id: task-create-golem-enemy
title: "Créer ennemi Golem"
description: "Ennemi de type golem pour le Temple"
sector: concept  # Secteur de départ
status: in_progress
is_parent: true

subtasks:
  - id: task-golem-concept
    sector: concept
    title: "Définir comportement Golem"
    status: done
    order: 1

  - id: task-golem-blueprint
    sector: dev
    title: "Blueprint BP_Golem"
    status: in_progress
    order: 2
    requires: [task-golem-concept]

  - id: task-golem-art
    sector: art
    title: "Mesh + Material Golem"
    status: locked
    order: 3
    requires: [task-golem-blueprint]  # Attend le BP pour les refs

  - id: task-golem-placement
    sector: levels
    title: "Placer dans L_Temple"
    status: locked
    order: 4
    requires: [task-golem-art]
```

### API Routes

```python
# GET /api/tasks
# Liste toutes les tasks groupées par queue

# GET /api/tasks/{id}
# Détail d'une task

# POST /api/tasks
# Créer une task
# Body: { title, description, sector, parent_id?, requires? }

# PATCH /api/tasks/{id}
# Modifier une task
# Body: { status?, sector?, priority?, ... }

# POST /api/tasks/{id}/history
# Ajouter une entrée d'historique
# Body: { action, notes? }

# GET /api/tasks/queues
# Liste les queues définies

# POST /api/tasks/{id}/subtasks
# Ajouter une sous-task
# Body: { title, sector, requires? }
```

### Store Zustand (tasksStore.ts)

```typescript
interface TasksState {
  tasks: Task[];
  queues: Queue[];
  isLoading: boolean;
  error: string | null;

  // Actions
  fetchTasks: () => Promise<void>;
  fetchQueues: () => Promise<void>;
  createTask: (data: CreateTaskInput) => Promise<Task>;
  updateTask: (id: string, data: Partial<Task>) => Promise<void>;
  moveTaskToQueue: (id: string, newSector: string) => Promise<void>;
  addHistoryEntry: (id: string, entry: HistoryEntry) => Promise<void>;

  // Computed
  getTasksByQueue: (queueId: string) => Task[];
  getReadyTasks: () => Task[];
  getLockedTasks: () => Task[];
  getDependentsOf: (taskId: string) => Task[];
}
```

### Types TypeScript

```typescript
interface Task {
  id: string;
  title: string;
  description: string;
  sector: string;
  agent: string;
  priority: 'low' | 'medium' | 'high' | 'critical';
  status: 'locked' | 'ready' | 'in_progress' | 'done';
  parent_id: string | null;
  requires: string[];
  history: HistoryEntry[];
  iteration: number;
  created_at: string;
  updated_at: string;
  created_by: 'user' | 'workflow' | 'editor';

  // Pour les parents
  is_parent?: boolean;
  subtasks?: Task[];
}

interface HistoryEntry {
  date: string;
  action: 'created' | 'started' | 'done' | 'reopened' | 'moved' | 'updated';
  by: 'user' | 'editor' | 'workflow';
  notes?: string;
  session?: string;
  reason?: string;
}

interface Queue {
  id: string;
  name: string;
  icon: string;
  color: string;
  description: string;
  default_agent: string;
}
```

## Logique de Dépendances

```python
def compute_task_status(task: Task, all_tasks: List[Task]) -> str:
    """
    Calcule le status d'une task basé sur ses dépendances.

    - Si toutes les dépendances sont 'done' → 'ready'
    - Si au moins une dépendance n'est pas 'done' → 'locked'
    - Si déjà 'in_progress' ou 'done' → garder
    """
    if task.status in ['in_progress', 'done']:
        return task.status

    for dep_id in task.requires:
        dep = find_task(dep_id, all_tasks)
        if dep and dep.status != 'done':
            return 'locked'

    return 'ready'
```

## Critères d'Acceptation

- [ ] CRUD complet pour les tasks
- [ ] Support des tasks parent/sous-tasks
- [ ] Calcul automatique du status (locked/ready)
- [ ] Historique append-only fonctionnel
- [ ] Déplacement d'une task entre secteurs
- [ ] API REST complète
- [ ] Store Zustand fonctionnel
- [ ] Types TypeScript complets
- [ ] Tests passent

## Tests à Écrire

### Unit Tests (Python)

```python
def test_create_task():
    # Crée une task, vérifie les valeurs par défaut

def test_task_status_computation():
    # Vérifie locked/ready selon dépendances

def test_add_history_entry():
    # Vérifie l'ajout d'entrée historique

def test_parent_task_with_subtasks():
    # Vérifie la création de tasks hiérarchiques

def test_move_task_to_queue():
    # Vérifie le changement de secteur
```

### Unit Tests (TypeScript)

```typescript
describe('tasksStore', () => {
  it('should compute task status based on dependencies');
  it('should group tasks by queue');
  it('should update task and add history');
});
```

### Integration Tests

```python
def test_full_task_lifecycle():
    # Crée → Start → Done → Reopen → Done

def test_parent_task_subtasks_flow():
    # Crée parent, ajoute subtasks, progresse
```

## Notes

- L'archivage se fait en déplaçant le fichier vers `archive/{année-mois}/`
- Les tasks "done" restent visibles mais grisées dans la queue
- Le status d'une task parent dépend des subtasks (done si toutes done)
- Prévoir des hooks pour les événements (task_created, task_done, etc.)
