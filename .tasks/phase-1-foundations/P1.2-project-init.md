# P1.2 Mise Ã  Jour project_init.py

## Objectif

Adapter le service d'initialisation de projet pour crÃ©er la nouvelle structure `.unreal-companion/` avec support des artifacts, tasks, et lien vers la config globale.

## PrÃ©requis

- [x] P1.1 - Structure globale ~/.unreal-companion/

## Fichiers Ã  Modifier

- `web-ui/server/services/project_init.py`

## Fichiers Ã  CrÃ©er (template)

```
MonProjet/.unreal-companion/
â”œâ”€â”€ config.yaml                    # Config projet spÃ©cifique
â”œâ”€â”€ context.md                     # Contexte IA (gÃ©nÃ©rÃ©/enrichi)
â”‚
â”œâ”€â”€ agents/
â”‚   â””â”€â”€ overrides/                 # Overrides locaux (rare)
â”‚       â””â”€â”€ .gitkeep
â”‚
â”œâ”€â”€ workflows/
â”‚   â””â”€â”€ overrides/                 # Overrides locaux (rare)
â”‚       â””â”€â”€ .gitkeep
â”‚
â”œâ”€â”€ artifacts/
â”‚   â”œâ”€â”€ briefs/                    # Game briefs
â”‚   â”œâ”€â”€ design/                    # GDD, mechanics
â”‚   â”œâ”€â”€ sessions/                  # Sessions brainstorming
â”‚   â”œâ”€â”€ boards/                    # Mood boards, mind maps (JSON)
â”‚   â””â”€â”€ index.yaml                 # Registre des artifacts
â”‚
â”œâ”€â”€ tasks/
â”‚   â”œâ”€â”€ queues.yaml                # DÃ©finition des secteurs
â”‚   â”œâ”€â”€ active/                    # Tasks par file
â”‚   â”‚   â”œâ”€â”€ concept/
â”‚   â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â”œâ”€â”€ art/
â”‚   â”‚   â””â”€â”€ levels/
â”‚   â”œâ”€â”€ archive/                   # Historique (jamais supprimÃ©)
â”‚   â””â”€â”€ index.yaml                 # Vue globale + dÃ©pendances
â”‚
â”œâ”€â”€ assets/
â”‚   â””â”€â”€ references/                # Images, concept art
â”‚
â””â”€â”€ .state/                        # Runtime (pas versionnÃ©)
    â””â”€â”€ current-session.json
```

## SpÃ©cifications

### config.yaml (projet)

```yaml
version: "2.0"

project:
  name: "{{PROJECT_NAME}}"
  uproject_path: "{{UPROJECT_PATH}}"
  created_at: "{{CREATED_AT}}"

# Overrides de la config globale (optionnel)
preferences:
  documents:
    default_language: fr  # Override pour ce projet
```

### context.md (template)

```markdown
# {{PROJECT_NAME}} - Contexte IA

> Ce document est enrichi automatiquement par les workflows et sessions.
> Il sert de rÃ©fÃ©rence principale pour les agents IA.

## Vision

_Ã€ dÃ©finir via le workflow Game Brief_

## Genre & RÃ©fÃ©rences

_Ã€ dÃ©finir_

## MÃ©caniques ClÃ©s

_Ã€ dÃ©finir_

## Notes Importantes

_AjoutÃ©es au fil du dÃ©veloppement_
```

### queues.yaml

> **Secteurs = Personnalisables !**
> L'utilisateur peut ajouter/modifier/supprimer des secteurs selon son projet.
> Le LLM peut aussi suggÃ©rer des secteurs pertinents.

```yaml
version: "1.0"

# Secteurs par dÃ©faut (l'user peut les dÃ©sactiver/rÃ©ordonner)
queues:
  # === Core (toujours utiles) ===
  - id: concept
    name: "Concept"
    icon: "Target"
    color: "blue"
    description: "Game design, mechanics, vision"
    default_agent: game-designer
    is_default: true

  - id: dev
    name: "Development"
    icon: "Code"
    color: "green"
    description: "Blueprints, systems, code"
    default_agent: game-architect
    is_default: true

  - id: art
    name: "Art"
    icon: "Palette"
    color: "pink"
    description: "Materials, textures, 3D assets"
    default_agent: 3d-artist
    is_default: true

  - id: levels
    name: "Level Design"
    icon: "Map"
    color: "amber"
    description: "Levels, lighting, world building"
    default_agent: level-designer
    is_default: true

  # === Creative (narration, audio, animation) ===
  - id: narrative
    name: "Narrative"
    icon: "BookOpen"
    color: "cyan"
    description: "Story, dialogues, lore, characters"
    default_agent: game-designer
    is_default: true

  - id: audio
    name: "Audio"
    icon: "Music"
    color: "purple"
    description: "Sound design, music, voice acting"
    default_agent: null
    is_default: true

  - id: animation
    name: "Animation"
    icon: "Play"
    color: "orange"
    description: "Character animation, cinematics, VFX"
    default_agent: null
    is_default: true

  # === Production (UI, QA, marketing) ===
  - id: ui
    name: "UI/UX"
    icon: "Layout"
    color: "indigo"
    description: "Menus, HUD, user experience"
    default_agent: null
    is_default: true

  - id: qa
    name: "QA"
    icon: "Bug"
    color: "red"
    description: "Testing, bugs, polish, feedback"
    default_agent: null
    is_default: true

  - id: marketing
    name: "Marketing"
    icon: "Megaphone"
    color: "rose"
    description: "Trailer, screenshots, store page, community"
    default_agent: null
    is_default: true
```

> **10 secteurs par dÃ©faut** couvrant tout le pipeline de dÃ©veloppement.
> L'utilisateur peut en dÃ©sactiver certains ou en ajouter d'autres.

**Secteurs suggÃ©rÃ©s par le LLM :**

```yaml
# Le LLM peut analyser le projet et suggÃ©rer des secteurs
llm_sector_suggestion:
  trigger: "project_init"  # ou "on_demand"
  prompt: |
    BasÃ© sur ce projet de jeu ({genre}, {scope}),
    suggÃ¨re des secteurs de production pertinents
    au-delÃ  des 4 par dÃ©faut.
```

**UI pour gÃ©rer les secteurs :**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš™ï¸ GÃ©rer les Secteurs                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Secteurs actifs:                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ¯ Concept      [par dÃ©faut]                    [â‰¡] â”‚   â”‚
â”‚  â”‚ ğŸ’» Development  [par dÃ©faut]                    [â‰¡] â”‚   â”‚
â”‚  â”‚ ğŸ¨ Art          [par dÃ©faut]                    [â‰¡] â”‚   â”‚
â”‚  â”‚ ğŸ—ºï¸ Levels       [par dÃ©faut]                    [â‰¡] â”‚   â”‚
â”‚  â”‚ ğŸµ Audio        [custom]                    [âœ•] [â‰¡] â”‚   â”‚
â”‚  â”‚ ğŸ“– Narrative    [custom]                    [âœ•] [â‰¡] â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  [+ Ajouter secteur]  [ğŸ¤– Suggestions IA]                  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### artifacts/index.yaml

```yaml
version: "1.0"

artifacts: []
# Sera peuplÃ© dynamiquement :
# - id: game-brief-v1
#   type: brief
#   path: briefs/game-brief.md
#   created_at: 2024-01-22T10:00:00Z
#   created_by: workflow:game-brief
#   versions: [...]
```

### tasks/index.yaml

```yaml
version: "1.0"

# Vue globale des tasks
tasks: []

# DÃ©pendances entre tasks
dependencies: []
# Exemple:
# - from: task-player-controller
#   to: task-core-loop
#   type: requires
```

## Logique d'Initialisation

```python
def init_companion_folder(project_path: str, web_ui_url: str = "http://localhost:8000"):
    """
    1. VÃ©rifier que la structure globale existe (appeler ensure_global_structure)
    2. CrÃ©er la structure projet
    3. Copier/traiter les templates
    4. Enregistrer dans projects.json global
    5. Retourner les infos projet
    """
```

## CritÃ¨res d'Acceptation

- [ ] Nouvelle structure projet crÃ©Ã©e correctement
- [ ] Templates avec variables remplacÃ©es ({{PROJECT_NAME}}, etc.)
- [ ] queues.yaml avec les 4 secteurs par dÃ©faut
- [ ] Dossiers active/ pour chaque secteur crÃ©Ã©s
- [ ] Lien vers structure globale fonctionnel
- [ ] Projet enregistrÃ© dans ~/.unreal-companion/projects.json
- [ ] RÃ©trocompatibilitÃ© : anciens projets sans .unreal-companion dÃ©tectÃ©s
- [ ] Tests passent

## Tests Ã  Ã‰crire

### Unit Tests

```python
def test_init_creates_all_directories():
    # VÃ©rifie que tous les dossiers sont crÃ©Ã©s

def test_init_creates_config_yaml():
    # VÃ©rifie le contenu du config.yaml projet

def test_init_creates_queues_yaml():
    # VÃ©rifie les 4 secteurs par dÃ©faut

def test_init_registers_project_globally():
    # VÃ©rifie l'enregistrement dans projects.json

def test_template_variables_replaced():
    # VÃ©rifie que {{PROJECT_NAME}} etc. sont remplacÃ©s
```

### Integration Tests

```python
def test_init_full_workflow():
    # CrÃ©e un projet complet, vÃ©rifie toute la structure

def test_init_with_existing_uproject():
    # Initialise sur un vrai dossier Unreal
```

## Notes

- Ne pas supprimer l'ancien code tant qu'on n'a pas migrÃ© les usages
- Ajouter des logs pour le debugging
- GÃ©rer le cas oÃ¹ .unreal-companion existe dÃ©jÃ  (ne pas Ã©craser)
