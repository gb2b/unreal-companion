# P1.2 Mise √† Jour project_init.py

## Objectif

Adapter le service d'initialisation de projet pour cr√©er la nouvelle structure `.unreal-companion/` avec support des artifacts, tasks, et lien vers la config globale.

## Pr√©requis

- [x] P1.1 - Structure globale ~/.unreal-companion/

## Fichiers √† Modifier

- `web-ui/server/services/project_init.py`

## Fichiers √† Cr√©er (template)

```
MonProjet/.unreal-companion/
‚îú‚îÄ‚îÄ config.yaml                    # Config projet sp√©cifique
‚îú‚îÄ‚îÄ context.md                     # Contexte IA (g√©n√©r√©/enrichi)
‚îÇ
‚îú‚îÄ‚îÄ agents/
‚îÇ   ‚îî‚îÄ‚îÄ overrides/                 # Overrides locaux (rare)
‚îÇ       ‚îî‚îÄ‚îÄ .gitkeep
‚îÇ
‚îú‚îÄ‚îÄ workflows/
‚îÇ   ‚îî‚îÄ‚îÄ overrides/                 # Overrides locaux (rare)
‚îÇ       ‚îî‚îÄ‚îÄ .gitkeep
‚îÇ
‚îú‚îÄ‚îÄ artifacts/
‚îÇ   ‚îú‚îÄ‚îÄ briefs/                    # Game briefs
‚îÇ   ‚îú‚îÄ‚îÄ design/                    # GDD, mechanics
‚îÇ   ‚îú‚îÄ‚îÄ sessions/                  # Sessions brainstorming
‚îÇ   ‚îú‚îÄ‚îÄ boards/                    # Mood boards, mind maps (JSON)
‚îÇ   ‚îî‚îÄ‚îÄ index.yaml                 # Registre des artifacts
‚îÇ
‚îú‚îÄ‚îÄ tasks/
‚îÇ   ‚îú‚îÄ‚îÄ queues.yaml                # D√©finition des secteurs
‚îÇ   ‚îú‚îÄ‚îÄ active/                    # Tasks par file
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ concept/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dev/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ art/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ levels/
‚îÇ   ‚îú‚îÄ‚îÄ archive/                   # Historique (jamais supprim√©)
‚îÇ   ‚îî‚îÄ‚îÄ index.yaml                 # Vue globale + d√©pendances
‚îÇ
‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îî‚îÄ‚îÄ references/                # Images, concept art
‚îÇ
‚îî‚îÄ‚îÄ .state/                        # Runtime (pas versionn√©)
    ‚îî‚îÄ‚îÄ current-session.json
```

## Sp√©cifications

### config.yaml (projet)

```yaml
version: "2.0"

project:
  name: "{{PROJECT_NAME}}"
  uproject_path: "{{UPROJECT_PATH}}"
  created_at: "{{CREATED_AT}}"

# Overrides de la config globale (optionnel)
preferences:
  documents:
    default_language: fr  # Override pour ce projet
```

### context.md (template)

```markdown
# {{PROJECT_NAME}} - Contexte IA

> Ce document est enrichi automatiquement par les workflows et sessions.
> Il sert de r√©f√©rence principale pour les agents IA.

## Vision

_√Ä d√©finir via le workflow Game Brief_

## Genre & R√©f√©rences

_√Ä d√©finir_

## M√©caniques Cl√©s

_√Ä d√©finir_

## Notes Importantes

_Ajout√©es au fil du d√©veloppement_
```

### queues.yaml

```yaml
version: "1.0"

queues:
  - id: concept
    name: "Concept"
    icon: "üéØ"
    color: "#3B82F6"
    description: "Game design, mechanics, vision"
    default_agent: game-designer

  - id: dev
    name: "Development"
    icon: "üíª"
    color: "#10B981"
    description: "Blueprints, systems, code"
    default_agent: game-architect

  - id: art
    name: "Art"
    icon: "üé®"
    color: "#EC4899"
    description: "Materials, assets, visuals"
    default_agent: 3d-artist

  - id: levels
    name: "Level Design"
    icon: "üó∫Ô∏è"
    color: "#F59E0B"
    description: "Levels, lighting, world building"
    default_agent: level-designer
```

### artifacts/index.yaml

```yaml
version: "1.0"

artifacts: []
# Sera peupl√© dynamiquement :
# - id: game-brief-v1
#   type: brief
#   path: briefs/game-brief.md
#   created_at: 2024-01-22T10:00:00Z
#   created_by: workflow:game-brief
#   versions: [...]
```

### tasks/index.yaml

```yaml
version: "1.0"

# Vue globale des tasks
tasks: []

# D√©pendances entre tasks
dependencies: []
# Exemple:
# - from: task-player-controller
#   to: task-core-loop
#   type: requires
```

## Logique d'Initialisation

```python
def init_companion_folder(project_path: str, web_ui_url: str = "http://localhost:8000"):
    """
    1. V√©rifier que la structure globale existe (appeler ensure_global_structure)
    2. Cr√©er la structure projet
    3. Copier/traiter les templates
    4. Enregistrer dans projects.json global
    5. Retourner les infos projet
    """
```

## Crit√®res d'Acceptation

- [ ] Nouvelle structure projet cr√©√©e correctement
- [ ] Templates avec variables remplac√©es ({{PROJECT_NAME}}, etc.)
- [ ] queues.yaml avec les 4 secteurs par d√©faut
- [ ] Dossiers active/ pour chaque secteur cr√©√©s
- [ ] Lien vers structure globale fonctionnel
- [ ] Projet enregistr√© dans ~/.unreal-companion/projects.json
- [ ] R√©trocompatibilit√© : anciens projets sans .unreal-companion d√©tect√©s
- [ ] Tests passent

## Tests √† √âcrire

### Unit Tests

```python
def test_init_creates_all_directories():
    # V√©rifie que tous les dossiers sont cr√©√©s

def test_init_creates_config_yaml():
    # V√©rifie le contenu du config.yaml projet

def test_init_creates_queues_yaml():
    # V√©rifie les 4 secteurs par d√©faut

def test_init_registers_project_globally():
    # V√©rifie l'enregistrement dans projects.json

def test_template_variables_replaced():
    # V√©rifie que {{PROJECT_NAME}} etc. sont remplac√©s
```

### Integration Tests

```python
def test_init_full_workflow():
    # Cr√©e un projet complet, v√©rifie toute la structure

def test_init_with_existing_uproject():
    # Initialise sur un vrai dossier Unreal
```

## Notes

- Ne pas supprimer l'ancien code tant qu'on n'a pas migr√© les usages
- Ajouter des logs pour le debugging
- G√©rer le cas o√π .unreal-companion existe d√©j√† (ne pas √©craser)
