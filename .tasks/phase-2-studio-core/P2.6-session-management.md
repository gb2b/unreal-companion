# P2.6 Gestion Sessions Workflow

## Objectif

ImplÃ©menter la sauvegarde automatique et la reprise des sessions de workflow, avec rÃ©sumÃ© adaptÃ© selon le temps Ã©coulÃ©.

## PrÃ©requis

- [x] P2.4 - Workflows YAML
- [x] P2.5 - ExpÃ©rience ludique

## Fichiers Ã  CrÃ©er

- `web-ui/server/services/session_service.py` - Gestion sessions
- `web-ui/server/routes/sessions.py` - API routes
- `web-ui/src/stores/sessionStore.ts` - Store sessions
- `web-ui/src/components/workflow/SessionResume.tsx` - UI reprise

## SpÃ©cifications

### Format Session YAML

```yaml
# .unreal-companion/sessions/game-brief-2024-01-22-abc123.yaml
id: "session-abc123"
workflow_id: game-brief
project_id: "project-xyz"

# Timestamps
started_at: 2024-01-22T10:00:00Z
last_activity: 2024-01-22T10:35:00Z
completed_at: null  # null si en cours

# Ã‰tat actuel
status: in_progress  # in_progress | paused | completed | abandoned
current_step: 3
current_question: "core_mechanics"

# RÃ©ponses collectÃ©es
responses:
  - step_id: vision
    question_id: elevator_pitch
    value: "Explorer un monde figÃ© dans le temps pour dÃ©couvrir pourquoi"
    answered_at: 2024-01-22T10:05:00Z
    agent_reaction:
      acknowledgment: "MystÃ©rieux Ã  souhait !"
      expression: excited
    time_spent_seconds: 120

  - step_id: vision
    question_id: core_fantasy
    value: "ÃŠtre un archÃ©ologue qui dÃ©code une civilisation perdue"
    answered_at: 2024-01-22T10:10:00Z
    agent_reaction:
      acknowledgment: "Ã‡a me rappelle Outer Wilds, j'adore !"
      connection: "Tu veux que le joueur se sente archÃ©ologue, Ã§a colle avec l'exploration"
      expression: excited

  - step_id: genre
    question_id: primary_genre
    value: "exploration"
    answered_at: 2024-01-22T10:15:00Z

# MÃ©triques
metrics:
  total_time_seconds: 2100
  questions_answered: 8
  questions_skipped: 1

# RÃ©sumÃ© gÃ©nÃ©rÃ© pour reprise
resume_summary: |
  On dÃ©finissait ton jeu d'exploration mystÃ©rieux inspirÃ©
  d'Outer Wilds. Tu incarnes un archÃ©ologue dans un monde
  figÃ©. On allait parler des mÃ©caniques de dÃ©couverte.
```

### Auto-save

```typescript
// Sauvegarde aprÃ¨s chaque rÃ©ponse
const saveSession = async (session: WorkflowSession) => {
  await api.sessions.save(session.id, session);
};

// Hook dans le workflow
const { addResponse } = useWorkflowSession();

const handleAnswer = async (questionId: string, value: string) => {
  const reaction = await generateReaction(value);

  addResponse({
    step_id: currentStep.id,
    question_id: questionId,
    value,
    answered_at: new Date().toISOString(),
    agent_reaction: reaction,
  });

  // Auto-save immÃ©diat
  await saveSession(session);
};
```

### DÃ©tection et Reprise

```typescript
// Au lancement d'un workflow
const existingSession = await findActiveSession(workflowId, projectId);

if (existingSession) {
  const timeSinceLastActivity = Date.now() - new Date(existingSession.last_activity).getTime();

  // Adapter le rÃ©sumÃ© selon le temps
  if (timeSinceLastActivity > 7 * 24 * 60 * 60 * 1000) {
    // Plus de 7 jours: rÃ©sumÃ© complet + suggestion de recommencer
    showFullRecap(existingSession, suggestRestart: true);
  } else if (timeSinceLastActivity > 24 * 60 * 60 * 1000) {
    // Plus de 24h: rÃ©sumÃ© complet
    showFullRecap(existingSession);
  } else {
    // Moins de 24h: rÃ©sumÃ© court
    showQuickResume(existingSession);
  }
}
```

### UI Reprise Session

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ² Game Designer                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  "Re ! On s'Ã©tait arrÃªtÃ©s hier sur ton jeu                  â”‚
â”‚   d'exploration â€” le monde figÃ© dans le temps,              â”‚
â”‚   trÃ¨s Outer Wilds.                                         â”‚
â”‚                                                             â”‚
â”‚   On allait dÃ©finir comment le joueur                       â”‚
â”‚   dÃ©couvre les secrets. PrÃªt Ã  continuer ?"                 â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“‹ Ce qu'on a dÃ©fini:                              â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  â€¢ Vision: Explorer un monde figÃ©...                â”‚   â”‚
â”‚  â”‚  â€¢ Genre: Exploration mystÃ©rieuse                   â”‚   â”‚
â”‚  â”‚  â€¢ Inspiration: Outer Wilds                         â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  [Voir tout le dÃ©tail â†“]                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  [â–¶ Continuer]  [â†º Recommencer]  [ğŸ“‹ Voir rÃ©sumÃ© complet] â”‚
â”‚                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  ğŸ“Š Game Brief : 2/5 Ã©tapes  â€¢  DerniÃ¨re activitÃ©: hier   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### API Routes

```python
# GET /api/sessions
# Liste les sessions du projet

# GET /api/sessions/{id}
# RÃ©cupÃ¨re une session

# GET /api/sessions/active?workflow_id=X&project_id=Y
# Trouve une session active pour ce workflow/projet

# POST /api/sessions
# CrÃ©e une nouvelle session

# PUT /api/sessions/{id}
# Met Ã  jour une session

# POST /api/sessions/{id}/responses
# Ajoute une rÃ©ponse

# PATCH /api/sessions/{id}/status
# Change le status (pause, complete, abandon)

# POST /api/sessions/{id}/resume-summary
# GÃ©nÃ¨re un rÃ©sumÃ© de reprise (LLM)
```

### GÃ©nÃ©ration RÃ©sumÃ© (LLM)

```python
RESUME_SUMMARY_PROMPT = """
L'utilisateur reprend une session de workflow aprÃ¨s {time_since_last}.

Workflow: {workflow_name}
Projet: {project_name}

RÃ©ponses donnÃ©es jusqu'ici:
{responses_formatted}

Ã‰tape actuelle: {current_step}
Prochaine question: {next_question}

GÃ©nÃ¨re un rÃ©sumÃ© de reprise:
- Court si < 24h (2-3 phrases)
- DÃ©taillÃ© si > 24h (rappeler les points clÃ©s)
- Avec proposition de recommencer si > 7 jours

Format: texte naturel, comme un collÃ¨gue qui rÃ©sume.
"""
```

## CritÃ¨res d'Acceptation

- [ ] Session sauvegardÃ©e aprÃ¨s chaque rÃ©ponse
- [ ] DÃ©tection de session existante au lancement
- [ ] RÃ©sumÃ© adaptÃ© selon le temps Ã©coulÃ©
- [ ] UI de reprise claire avec options
- [ ] PossibilitÃ© de recommencer (nouvelle session)
- [ ] PossibilitÃ© de voir le dÃ©tail des rÃ©ponses
- [ ] Historique des sessions terminÃ©es consultable
- [ ] Tests passent

## Tests Ã  Ã‰crire

### Unit Tests

```python
def test_create_session():
    # VÃ©rifie la crÃ©ation avec valeurs par dÃ©faut

def test_add_response_to_session():
    # VÃ©rifie l'ajout et l'auto-save

def test_find_active_session():
    # VÃ©rifie la recherche par workflow/projet

def test_resume_summary_generation():
    # VÃ©rifie que le LLM gÃ©nÃ¨re un rÃ©sumÃ© valide
```

### Unit Tests (React)

```typescript
describe('SessionResume', () => {
  it('should show short summary for recent session');
  it('should show full summary for old session');
  it('should suggest restart for very old session');
  it('should allow continuing or restarting');
});
```

### E2E Tests

```typescript
describe('Session E2E', () => {
  it('should save and resume a workflow session');
  it('should show correct summary after 24h');
});
```

## Notes

- Les sessions sont stockÃ©es en YAML pour Ãªtre lisibles
- Une session par workflow par projet (pas de sessions parallÃ¨les)
- "Abandonner" ne supprime pas, marque juste le status
- Les sessions complÃ©tÃ©es restent pour historique
- PrÃ©voir une limite de sessions conservÃ©es (ex: 50 derniÃ¨res)
